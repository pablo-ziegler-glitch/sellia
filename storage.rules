rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    function isAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    function hasSuperAdminClaim() {
      return isAuthenticated()
        && request.auth.token.superAdmin == true;
    }

    function hasUserProfile() {
      return firestore.exists(/databases/(default)/documents/users/$(request.auth.uid));
    }

    function userDocData() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data;
    }

    function isUserActive() {
      let status = userDocData().status is string
        ? userDocData().status.lower()
        : null;
      return hasUserProfile()
        && (
          // Compat legacy: si no existe status/isActive, asumimos activa para no romper
          // cuentas creadas antes de normalizar estos campos.
          (!(userDocData().status is string) && !(userDocData().isActive is bool))
          || status == 'active'
          || userDocData().isActive == true
        );
    }

    function normalizedRole() {
      return userDocData().role is string
        ? userDocData().role.lower()
        : null;
    }

    function hasLegacyWriteRoleAlias() {
      let role = normalizedRole();
      return role in ['super_admin', 'superadmin', 'seller', 'employee'];
    }

    function userTenantId() {
      return userDocData().tenantId is string
        ? userDocData().tenantId
        : (
            userDocData().storeId is string
            ? userDocData().storeId
            : null
          );
    }

    function hasTenantWriteRole() {
      let role = normalizedRole();
      return hasSuperAdminClaim()
        || (
          hasUserProfile()
          && (
            role in ['owner', 'manager', 'cashier', 'admin']
            || hasLegacyWriteRoleAlias()
            || userDocData().isAdmin == true
            || userDocData().isSuperAdmin == true
          )
        );
    }

    function isTenantUser(tenantId) {
      return isAuthenticated()
        && (
          hasSuperAdminClaim()
          || (
            userTenantId() == tenantId
            && isUserActive()
          )
        );
    }

    function canWriteTenantStorage(tenantId) {
      return isTenantUser(tenantId) && hasTenantWriteRole();
    }

    match /tenants/{tenantId}/products/{productId}/{allPaths=**} {
      allow read: if isTenantUser(tenantId);
      allow write: if canWriteTenantStorage(tenantId);
    }

    match /tenants/{tenantId}/public_products/{productId}/images/{allPaths=**} {
      allow read: if true;
      allow write: if canWriteTenantStorage(tenantId);
    }

    // List/get del prefijo raíz (algunos SDK evalúan list sobre el prefijo exacto)
    match /Images/public/catalog {
      allow read: if true;
    }

    match /Images/public/catalog/{allPaths=**} {
      allow read: if true;
      allow write: if hasSuperAdminClaim();
    }
  }
}
