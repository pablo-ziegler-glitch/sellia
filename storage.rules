rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    function isAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    function isFixedSuperAdmin() {
      return isAuthenticated()
        && request.auth.token.email is string
        && request.auth.token.email.lower() == 'pabloz18ezeiza@gmail.com';
    }

    function hasUserProfile() {
      return firestore.exists(/databases/(default)/documents/users/$(request.auth.uid));
    }

    function userDocData() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data;
    }

    function isUserActive() {
      return hasUserProfile()
        && (
          // Compat legacy: si no existe status/isActive, asumimos activa para no romper
          // cuentas creadas antes de normalizar estos campos.
          (!(userDocData().status is string) && !(userDocData().isActive is bool))
          || userDocData().status == 'active'
          || userDocData().isActive == true
        );
    }

    function userTenantId() {
      return userDocData().tenantId is string
        ? userDocData().tenantId
        : (
            userDocData().storeId is string
            ? userDocData().storeId
            : null
          );
    }

    function hasTenantWriteRole() {
      return isFixedSuperAdmin()
        || (
          hasUserProfile()
          && (
            userDocData().role in ['owner', 'manager', 'cashier', 'admin']
            || userDocData().isAdmin == true
            || userDocData().isSuperAdmin == true
          )
        );
    }

    function isTenantUser(tenantId) {
      return isAuthenticated()
        && (
          isFixedSuperAdmin()
          || (
            userTenantId() == tenantId
            && isUserActive()
          )
        );
    }

    function canWriteTenantStorage(tenantId) {
      return isTenantUser(tenantId) && hasTenantWriteRole();
    }

    match /tenants/{tenantId}/products/{productId}/{allPaths=**} {
      allow read: if isTenantUser(tenantId);
      allow write: if canWriteTenantStorage(tenantId);
    }

    match /tenants/{tenantId}/public_products/{productId}/images/{allPaths=**} {
      allow read: if true;
      allow write: if canWriteTenantStorage(tenantId);
    }

    // List/get del prefijo raíz (algunos SDK evalúan list sobre el prefijo exacto)
    match /Images/public/catalog {
      allow read: if true;
    }

    match /Images/public/catalog/{allPaths=**} {
      allow read: if true;
      allow write: if isFixedSuperAdmin();
    }
  }
}
